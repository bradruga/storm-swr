
REM  PIPE FLOW CALCULATION ROUTINE
'------------------------------------------------------------------------'

PIPEFLOW:
  ON ERROR GOTO 0
  CLS:I5%=NUM1%
  C1=15:C2=5:C3=1:C4=15
  GOSUB FILETEST
  IF I2%=0 THEN
    LOCATE 10,25:COLOR 15,0:PRINT "NO SUBAREAS HAVE BEEN ENTERED!"
    DELAY 3:COLOR 7,0
    GOTO START
  END IF
  GOSUB HEADING
  IF NUM1%>1 THEN
    GOSUB UPPERPIPE
    GOSUB PRINTUPPERPIPE
    GOSUB LOWERPIPE
    GOSUB PRINTLOWERPIPE
  END IF
  IF NUM1%=1 THEN
    GOSUB LOWERPIPE
    GOSUB PRINTLOWERPIPE
  END IF
  IF NUM1%=0 THEN
    GOSUB LOWERPIPE
    GOSUB NEWPIPE
  END IF
  GOSUB PIPEMENU
  ENTER2:
    D1$ = INKEY$
    IF (LEN(D1$)) <> 2 THEN ENTER2
    IF D1$ = CHR$(0)+CHR$(59) THEN GOSUB REVISEDATA
    IF D1$ = CHR$(0)+CHR$(60) THEN GOSUB ADJUSTSLOPE
    IF D1$ = CHR$(0)+CHR$(61) THEN GOSUB MOVEFORWARD
    IF D1$ = CHR$(0)+CHR$(62) THEN GOSUB MOVEBACKWARD
    IF D1$ = CHR$(0)+CHR$(63) THEN GOSUB NEWPIPE
    IF D1$ = CHR$(0)+CHR$(64) THEN GOSUB INSERTPIPE
    IF D1$ = CHR$(0)+CHR$(65) THEN GOSUB DELETEPIPE
    IF D1$ = CHR$(0)+CHR$(66) THEN GOSUB REVISESYSTEM
    IF D1$ = CHR$(0)+CHR$(67) THEN GOTO EXITPIPE
  GOTO ENTER2



LOWERPIPE:
  COLOR C1,C2
  LOCATE 10,1:PRINT"    1      2       3       4      5      6      7      8      9     10    11    "
  COLOR C2,C3
  LOCATE 11,1:PRINT CHR$(179)
  COLOR C4,C3
  LOCATE 11,2:PRINT" AREA   FROM     TO     INCR.  TOTAL    C     TO     IN    TIME     I     Q   "
  COLOR C2,C3:LOCATE 11,80:PRINT CHR$(179)
  LOCATE 12,1:PRINT CHR$(179)
  COLOR C4,C3
  LOCATE 12,2:PRINT"                          A      A           INLET  CHAN.  CONC.        (CFS) "
  COLOR C2,C3:LOCATE 12,80:PRINT CHR$(179)
  COLOR C1,C2
  LOCATE 15,5:PRINT"   12     13     14      15     16     17     18    19      20     21   "
  COLOR C2,C3:LOCATE 16,5:PRINT CHR$(179)
  COLOR C4,C3
  LOCATE 16,6:PRINT" PIPE    S      N      CAP.   VEL.   VEL.   LEN.  FALL   UPPER  LOWER "
  COLOR C2,C3:LOCATE 16,76:PRINT CHR$(179)
  LOCATE 17,5:PRINT CHR$(179)
  COLOR C4,C3
  LOCATE 17,6:PRINT" SIZE   (%)           (CFS)   FULL   ACT.   (FT)  (FT)    INV.   INV. "
  COLOR C2,C3:LOCATE 17,76:PRINT CHR$(179)
  COLOR 7,0
RETURN

UPPERPIPE:
  COLOR C4,C3
  LOCATE 3,1:PRINT"  AREA   FROM     TO     INCR.  TOTAL    C     TO     IN    TIME     I     Q    "
  LOCATE 4,1:PRINT"                           A      A           INLET  CHAN.  CONC.        (CFS)  "
  LOCATE 6,5:PRINT"  PIPE    S      N      CAP.   VEL.   VEL.   LEN.  FALL   UPPER  LOWER  "
  LOCATE 7,5:PRINT"  SIZE   (%)           (CFS)   FULL   ACT.   (FT)  (FT)    INV.   INV.  "
  COLOR 7,0
RETURN

PIPEMENU:
  COLOR 15,0
  LOCATE 20,4:PRINT"F1 --- REVISE DATA        F4 --- MOVE BACKWARD       F7 --- DELETE PIPE"	
  LOCATE 21,4:PRINT"F2 --- ADJUST SLOPE       F5 --- NEW PIPE            F8 --- REVISE SYSTEM"	
  LOCATE 22,4:PRINT"F3 --- MOVE FORWARD       F6 --- INSERT PIPE         F9 --- EXIT"
  LOCATE 23,28:PRINT"???? PRESS FUNCTION ????"
  COLOR 7,0
RETURN

PRINTUPPERPIPE:
  IF I5%=1 THEN RETURN
  LOCATE 5,3:PRINT A5$(I5%-1)
  LOCATE 5,10:PRINT IN1$(I5%-1)
  LOCATE 5,18:PRINT IN2$(I5%-1)
  LOCATE 5,25:PRINT USING "###.##"; A6#(I5%-1)
  LOCATE 5,32:PRINT USING "###.##"; A7#(I5%-1)
  LOCATE 5,40:PRINT USING "#.##"; COMP1#(I5%-1)
  LOCATE 5,46:PRINT USING "###.##"; T1#(I5%-1)
  LOCATE 5,53:PRINT USING "###.##"; T2#(I5%-1)
  LOCATE 5,60:PRINT USING "###.##"; T3#(I5%-1)
  LOCATE 5,68:PRINT USING "#.##"; INT1#(I5%-1)
  LOCATE 5,73:PRINT USING "###.##"; Q#(I5%-1)
  LOCATE 8,7:PRINT D$(I5%-1)
  LOCATE 8,13:PRINT USING "#.###"; SL#(I5%-1)*100
  LOCATE 8,20:PRINT USING "#.###"; N#(I5%-1)
  LOCATE 8,27:PRINT USING "###.##"; Q1#(I5%-1)
  LOCATE 8,35:PRINT USING "##.##"; V#(I5%-1)
  LOCATE 8,42:PRINT USING "##.##"; V1#(I5%-1)
  LOCATE 8,49:PRINT USING "####"; L#(I5%-1)
  LOCATE 8,55:PRINT USING "##.##"; F#(I5%-1)
  LOCATE 8,62:PRINT USING "###.##"; U1#(I5%-1)
  LOCATE 8,69:PRINT USING "###.##"; L1#(I5%-1)
RETURN

PRINTLOWERPIPE:
  LOCATE 13,3:PRINT A5$(I5%)
  LOCATE 13,10:PRINT IN1$(I5%)
  LOCATE 13,18:PRINT IN2$(I5%)
  LOCATE 13,25:PRINT USING "###.##"; A6#(I5%)
  LOCATE 13,32:PRINT USING "###.##"; A7#(I5%)
  LOCATE 13,40:PRINT USING "#.##"; COMP1#(I5%)
  LOCATE 13,46:PRINT USING "###.##"; T1#(I5%)
  LOCATE 13,53:PRINT USING "###.##"; T2#(I5%)
  LOCATE 13,60:PRINT USING "###.##"; T3#(I5%)
  LOCATE 13,68:PRINT USING "#.##"; INT1#(I5%)
  LOCATE 13,73:PRINT USING "###.##"; Q#(I5%)
  LOCATE 18,7:PRINT D$(I5%)
  LOCATE 18,13:PRINT USING "#.###"; SL#(I5%)*100
  LOCATE 18,20:PRINT USING "#.###"; N#(I5%)
  LOCATE 18,27:PRINT USING "###.##"; Q1#(I5%)
  LOCATE 18,35:PRINT USING "##.##"; V#(I5%)
  LOCATE 18,42:PRINT USING "##.##"; V1#(I5%)
  LOCATE 18,49:PRINT USING "####"; L#(I5%)
  LOCATE 18,55:PRINT USING "##.##"; F#(I5%)
  LOCATE 18,62:PRINT USING "###.##"; U1#(I5%)
  LOCATE 18,69:PRINT USING "###.##"; L1#(I5%)
RETURN

REVISEDATA:
  GOSUB CLEARMENU
  LOCATE 20,26:PRINT"ENTER NUMBER TO BE REVISED:"
  H$="1":LOCATE 20,54:CALL PROM(H$,2,1)
  H%=VAL(H$)
  IF H%=1 THEN GOSUB CHANGEA5
  IF H%=2 THEN GOSUB CHANGEIN1
  IF H%=3 THEN GOSUB CHANGEIN2
  IF H%=12 THEN GOSUB CHANGED
  IF H%=13 THEN GOSUB CHANGESL
  IF H%=14 THEN GOSUB CHANGEN
  IF H%=18 THEN GOSUB CHANGEL
  IF H%=20 THEN GOSUB CHANGEU1
  IF H%=21 THEN GOSUB CHANGEL1
  GOSUB PIPEMENU
RETURN

ADJUSTSLOPE:
  SL#(I5%)=(Q#(I5%)^2)*(SL#(I5%))/(Q1#(I5%)^2)
  GOSUB CALCULATEPIPEFLOW
  LOCATE 18,13:PRINT USING "#.###"; SL#(I5%)*100
  GOSUB CALCULATEFT2L1
RETURN

MOVEFORWARD:
  GOSUB CLEARMENU
  LOCATE 20,26:PRINT"ENTER NUMBER OF PIPES TO ADVANCE:"
  LOCATE 21,26:PRINT"(ENTRY OF UPPER INLET WILL CALL PIPE)"
  MOVEFORWARD1:
  INVALIDVALUE=0
  H$="1":LOCATE 20,60:CALL PROM(H$,5,1)
  H%=VAL(H$):I5%=I5%+H%
  IF I5%>NUM1% THEN I5%=NUM1%
  IF MID$(H$,1,1)="I" OR MID$(H$,1,1)="M" THEN GOSUB DETERMINECURRENTI5
  IF INVALIDVALUE=1 THEN GOTO MOVEFORWARD1
  GOSUB PRINTLOWERPIPE
  IF I5%>1 THEN
    GOSUB PRINTUPPERPIPE
  END IF
  GOSUB PIPEMENU
RETURN

MOVEBACKWARD:
  GOSUB CLEARMENU
  LOCATE 20,26:PRINT"ENTER NUMBER OF PIPES TO MOVE BACKWARD:"
  LOCATE 21,26:PRINT"(ENTRY OF UPPER INLET WILL CALL PIPE)"
  MOVEBACKWARD1:
  INVALIDVALUE=0
  H$="1":LOCATE 20,66:CALL PROM(H$,5,1)
  H%=VAL(H$):I5%=I5%-H%
  IF I5%<1 THEN I5%=1
  IF MID$(H$,1,1)="I" OR MID$(H$,1,1)="M" THEN GOSUB DETERMINECURRENTI5
  IF INVALIDVALUE=1 THEN GOTO MOVEBACKWARD1
  GOSUB PRINTLOWERPIPE
  IF I5%>1 THEN
    GOSUB PRINTUPPERPIPE
  END IF
  GOSUB PIPEMENU
RETURN

DETERMINECURRENTI5:
  FOR J%=1 TO NUM1%
    IF IN1$(J%)=H$ THEN
      I5%=J%
      RETURN
    END IF
  NEXT J%
  INVALIDVALUE=1
  RETURN
RETURN

NEWPIPE:
  INCR NUM1%:I5%=NUM1%
  IF I5%>1 THEN
    GOSUB UPPERPIPE
    GOSUB PRINTUPPERPIPE
    GOSUB CLEARLOWERPIPE
  END IF
  GOSUB ENTERPIPEINFO
RETURN

INSERTPIPE:
  GOSUB CLEARMENU
  LOCATE 20,5:PRINT"ENTER UPPER INLET OF PIPE TO BE INSERTED BEFORE:"
  INSERTPIPE1:
  INVALIDVALUE=0
  H$=IN1$(I5%):LOCATE 20,54:CALL PROM(H$,5,2)
  GOSUB DETERMINECURRENTI5
  IF INVALIDVALUE=1 THEN GOTO INSERTPIPE1
  GOSUB PRINTUPPERPIPE
  GOSUB CLEARLOWERPIPE
  INCR NUM1%
  FOR J%=NUM1% TO I5%+1 STEP -1
    A5$(J%)=A5$(J%-1)
    IN1$(J%)=IN1$(J%-1)
    IN2$(J%)=IN2$(J%-1)
    A6#(J%)=A6#(J%-1)
    A7#(J%)=A7#(J%-1)
    COMP1#(J%)=COMP1#(J%-1)
    T1#(J%)=T1#(J%-1)
    T2#(J%)=T2#(J%-1)
    T3#(J%)=T3#(J%-1)
    INT1#(J%)=INT1#(J%-1)
    Q#(J%)=Q#(J%-1)
    D$(J%)=D$(J%-1)
    SL#(J%)=SL#(J%-1)
    N#(J%)=N#(J%-1)
    Q1#(J%)=Q1#(J%-1)
    V#(J%)=V#(J%-1)
    V1#(J%)=V1#(J%-1)
    L#(J%)=L#(J%-1)
    F#(J%)=F#(J%-1)
    U1#(J%)=U1#(J%-1)
    L1#(J%)=L1#(J%-1)
    D#(J%)=D#(J%-1)
  NEXT J%
  GOSUB ENTERPIPEINFO
  GOSUB PIPEMENU
RETURN

DELETEPIPE:
  GOSUB CLEARMENU
  LOCATE 20,5:PRINT"ENTER UPPER INLET OF PIPE TO BE DELETED:"
  DELETEPIPE1:
  INVALIDVALUE=0
  H$=IN1$(I5%):LOCATE 20,46:CALL PROM(H$,5,2)
  GOSUB DETERMINECURRENTI5
  IF INVALIDVALUE=1 THEN GOTO DELETEPIPE1
  DECR NUM1%
  IF I5%>NUM1% THEN
    I5%=NUM1%
    GOTO DELETEPIPE2
  END IF
  FOR J%=I5% TO NUM1%
    A5$(J%)=A5$(J%+1)
    IN1$(J%)=IN1$(J%+1)
    IN2$(J%)=IN2$(J%+1)
    A6#(J%)=A6#(J%+1)
    A7#(J%)=A7#(J%+1)
    COMP1#(J%)=COMP1#(J%+1)
    T1#(J%)=T1#(J%+1)
    T2#(J%)=T2#(J%+1)
    T3#(J%)=T3#(J%+1)
    INT1#(J%)=INT1#(J%+1)
    Q#(J%)=Q#(J%+1)
    D$(J%)=D$(J%+1)
    SL#(J%)=SL#(J%+1)
    N#(J%)=N#(J%+1)
    Q1#(J%)=Q1#(J%+1)
    V#(J%)=V#(J%+1)
    V1#(J%)=V1#(J%+1)
    L#(J%)=L#(J%+1)
    F#(J%)=F#(J%+1)
    U1#(J%)=U1#(J%+1)
    L1#(J%)=L1#(J%+1)
    D#(J%)=D#(J%+1)
  NEXT J%
  DELETEPIPE2:
  GOSUB PRINTUPPERPIPE
  GOSUB PRINTLOWERPIPE
  GOSUB PIPEMENU
RETURN

REVISESYSTEM:
  I6%=I5%
  FOR I5%=1 TO NUM1%
    GOSUB CALCREQFLOW
    GOSUB CALCULATEPIPEFLOW
    F#(I5%)=SL#(I5%)*L#(I5%)
    T2#(I5%)=L#(I5%)/(V1#(I5%)*60)
  NEXT I5%
  I5%=I6%
RETURN

ENTERPIPEINFO:
  GOSUB ENTERA5
  GOSUB ENTERIN1
  GOSUB ENTERIN2
  GOSUB CALCREQFLOW
  PIPEENTRY:
  GOSUB ENTERPIPESIZE
  GOSUB ENTERSLOPE
  GOSUB ENTERMANNINGSN
  GOSUB CALCULATEPIPEFLOW
  IF INVALIDSIZE=1 THEN GOTO PIPEENTRY
  GOSUB ENTERPIPELENGTH
  GOSUB ENTERUPPERINVERT
RETURN

EXITPIPE:
  NUM1%=I5%
  GOTO START


ENTERA5:
  IF A5$(I5%)=CHT$(0) THEN
    A5$(I5%)="A1"
    IF I5%>1 THEN
      A9$=MID$(A5$(I5%-1),2,4):A%=VAL(A9$):INCR A%
      A5$(I5%)=MID$(A5$(I5%-1),1,1)+MID$(STR$(A%),2,4)
      IF A5$(I5%-1)="----" THEN
        FOR I%=I5%-1 TO 1 STEP -1
          IF A5$(I%)<>"----" THEN EXIT FOR
        NEXT I%
        A9$=MID$(A5$(I%),2,4):A%=VAL(A9$):INCR A%
        A5$(I5%)=MID$(A5$(I%),1,1)+MID$(STR$(A%),2,4)
      END IF
    END IF
  END IF
  NUM%=2:IF I5%=1 THEN NUM%=1
  LOCATE 13,3:CALL PROM(A5$(I5%),4,NUM%)
  FOR K% = 1 TO I2%
    IF A5$(I5%)=A$(K%) THEN RETURN
  NEXT K%
  IF A5$(I5%)="-   " OR A5$(I5%)="--  " OR A5$(I5%)="--- " _
                      OR A5$(I5%)="----" OR A5$(I5%)="    " THEN
    IF I5%=1 THEN ENTERA5
    A5$(I5%)="----":LOCATE 13,3:PRINT A5$(I5%)
    RETURN
  END IF
GOTO ENTERA5

ENTERIN1:
  NUM%=2
  IF IN1$(I5%)=CHT$(0) THEN
    IF A5$(I5%)="----" THEN
      FOR I%=I5% TO 1 STEP -1
        IF A5$(I%)<>"----" THEN EXIT FOR
      NEXT I%
      A$=STR$(VAL(MID$(A5$(I%),2,4)))
      A$=MID$(A$,2,(LEN(A$)-1))
      IN1$(I5%)="MH"+A$+CHR$(64+(I5%-I%))
      NUM%=3
    END IF
    IF A5$(I5%)<>"----" THEN IN1$(I5%)="I"+MID$(A5$(I5%),2,4)
  END IF
  ENTERUPPERINLET:
  LOCATE 13,10:CALL PROM(IN1$(I5%),5,NUM%)
  IF A5$(I5%)="----" THEN
    FOR I%=1 TO I5%-1
      IF IN1$(I5%)=IN2$(I%) THEN ENDENTERIN1
    NEXT I%
    GOTO ENTERUPPERINLET
  END IF
ENDENTERIN1:
RETURN

ENTERIN2:
  NUM%=2
  IF IN2$(I5%)=CHT$(0) THEN
    IF A5$(I5%)="----" THEN
      FOR I%=I5% TO 1 STEP -1
        IF A5$(I%)<>"----" THEN EXIT FOR
      NEXT I%
      A$=STR$((VAL(MID$(A5$(I%),2,4))+1))
      A$=MID$(A$,2,(LEN(A$)-1))
      IN2$(I5%)="I"+A$
    END IF
    IF A5$(I5%)<>"----" THEN
      A%=1+VAL(MID$(A5$(I5%),2,4))
      A$=STR$(A%)
      IN2$(I5%)="I"+MID$(A$,2,(LEN(A$)-1))
    END IF
  END IF
  LOCATE 13,18:CALL PROM(IN2$(I5%),5,NUM%)
RETURN

CALCREQFLOW:
  A6#(I5%)=A5#(K%)
  A7#(I5%)=A5#(K%)
  T1#(I5%)=T8#(K%)
  T3#(I5%)=T8#(K%)
  COMP1#(I5%)=C#(K%)*A7#(I5%)
  LOCATE 13,25:PRINT USING "###.##"; A6#(I5%)
  FOR J%=1 TO I5%-1
    IF IN2$(J%) = IN1$(I5%) THEN
      A7#(I5%)=A7#(I5%)+A7#(J%)
      COMP1#(I5%)=COMP1#(I5%)+A7#(J%)*COMP1#(J%)
      IF T3#(I5%)<T2#(J%)+T3#(J%) THEN T3#(I5%)=T2#(J%)+T3#(J%)
    END IF
  NEXT J%
  COMP1#(I5%)=COMP1#(I5%)/A7#(I5%)
  TIMECONC#=T3#(I5%):GOSUB INTENSITY
  INT1#(I5%)=INTENS#
  Q#(I5%)=COMP1#(I5%)*INT1#(I5%)*A7#(I5%)
  LOCATE 13,32:PRINT USING "###.##"; A7#(I5%)
  LOCATE 13,40:PRINT USING "#.##"; COMP1#(I5%)
  LOCATE 13,46:PRINT USING "###.##"; T1#(I5%)
  LOCATE 13,60:PRINT USING "###.##"; T3#(I5%)
  LOCATE 13,68:PRINT USING "#.##"; INT1#(I5%)
  LOCATE 13,73:PRINT USING "###.##"; Q#(I5%)
RETURN

ENTERPIPESIZE:
  IF D$(I5%)=CHT$(0) THEN D$(I5%)="15"
  LOCATE 18,7:CALL PROM(D$(I5%),4,1)
RETURN

ENTERSLOPE:
  IF SL#(I5%)=0 THEN SL#(I5%)=0.005
  SLOPE#=SL#(I5%)*100
  SL$="0"+MID$(STR$(SLOPE#),2,4)
  ENTERSLOPE1:
    LOCATE 18,13:CALL PROM(SL$,5,3)
    SL#(I5%)=(VAL(SL$))/100
  IF SL#(I5%)=0 THEN GOTO ENTERSLOPE1
RETURN

ENTERMANNINGSN:
  IF N#(I5%)=0 THEN N#(I5%)=0.013
  MANN1#=1000*N#(I5%)
  MANN$="0.0"+MID$(STR$(MANN1#),2,3)
  ENTERMANNINGSN1:
    LOCATE 18,20:CALL PROM(MANN$,5,1)
    N#(I5%)=VAL(MANN$)
  IF N#(I5%)=0 THEN GOTO ENTERMANNINGSN1
RETURN

CALCULATEPIPEFLOW:
  INVALIDSIZE=0
  IF MID$(D$(I5%),3,2)="  " THEN GOTO ROUNDPIPE
  IF VAL(MID$(D$(I5%),3,1))>0 AND MID$(D$(I5%),4,1)=" " THEN GOTO ROUNDPIPE
  IF MID$(D$(I5%),3,1)="0" THEN GOTO ROUNDPIPE
  IF N#(I5%)>0.015 THEN
    INVALIDSIZE = 1
    RETURN
  END IF
  IF MID$(D$(I5%),3,1)="H" THEN
    A$=MID$(D$(I5%),3,1)
    D#(I5%)=VAL(MID$(D$(I5%),1,2))
  END IF
  IF MID$(D$(I5%),3,1)="V" THEN
    A$=MID$(D$(I5%),3,1)
    D#(I5%)=VAL(MID$(D$(I5%),1,2))
  END IF
  IF MID$(D$(I5%),4,1)="H" OR MID$(D$(I5%),4,1)="V" THEN
    A$=MID$(D$(I5%),4,1)
    D#(I5%)=VAL(MID$(D$(I5%),1,3))
  END IF
  IF A$="H" THEN GOTO ELLIPTICALPIPE
  IF A$="V" THEN GOTO ELLIPTICALPIPE
  INVALIDSIZE = 1
  RETURN
  ROUNDPIPE:
    D#(I5%)=VAL(D$(I5%))
    A#=(D#(I5%)/24)^2*PI#
    R#=(D#(I5%)/48)
    Q1#(I5%) = ((1.486)/(N#(I5%)))*A#*(R#^(2/3))*(SL#(I5%)^.5)
    V#(I5%)=Q1#(I5%)/A#
    IF Q1#(I5%)>Q#(I5%) THEN GOTO ROUNDPARTIALFLOW
    V1#(I5%)=V#(I5%)
    GOTO PRINTFLOW
    ROUNDPARTIALFLOW:
      X#=D#(I5%)/24:X1#=X#:Y#=X#
      ROUNDPARTIALFLOW1:
        X3#=Y#-X#:IF X3#=0 THEN X3#=0.0000001
        Y2#=(114.591559)*(ATN((((X#)*(2*Y#-X#))^.5)/(X3#)))
        IF Y2#<0 THEN Y2#=360-ABS(Y2#)
        W1#=Y2#*PI#*D#(I5%)/(4320)
        A1#=((PI#*(Y#^2)*Y2#)/360)-(Y#-X#)*((Y#^2)-(Y#-X#)^2)^.5
        R1#=A1#/W1#
        Q3#=((1.486)/(N#(I5%)))*A1#*(R1#^(2/3))*(SL#(I5%)^.5)
        IF ABS(Q3#-Q#(I5%))<.001 THEN
          V1#(I5%)=Q3#/A1#
          GOTO PRINTFLOW
        END IF
        X1#=X1#/2
        IF Q3#>Q#(I5%) THEN
          X#=X#-X1#
          GOTO ROUNDPARTIALFLOW1
        END IF
        X#=X#+X1#
        GOTO ROUNDPARTIALFLOW1
  ELLIPTICALPIPE:
    FOR J%=1 TO 23
      IF D#(I5%)=MAJORSIZE#(J%) THEN GOTO ELLIP1
    NEXT J%
    INVALIDSIZE=1:RETURN
    ELLIP1:
      Q1#(I5%)=(1.486/N#(I5%))*ELLIPAREA#(J%)*(ELLIPR#(J%)^(2/3))*(SL#(I5%)^.5)
      V#(I5%)=Q1#(I5%)/ELLIPAREA#(J%)
      A#=ELLIPAREA#(J%)     'A# is used in ADJUST SLOPE
      IF Q1#(I5%)<=Q#(I5%) THEN
        V1#(I5%)=V#(I5%)
        GOTO PRINTFLOW
      END IF
      PARTFLOW1#=Q#(I5%)/Q1#(I5%)
      FOR J%=1 TO 24
        IF QQF#(J%)>PARTFLOW1# THEN GOTO CALCULATEPARTELLIPFLOW
      NEXT J%
      J%=24
      CALCULATEPARTELLIPFLOW:
      PERCENTFLOW#=((PARTFLOW1#-QQF#(J%-1))/(QQF#(J%)-QQF#(J%-1)))
      REM PRINT A$:STOP
      IF A$="V" THEN GOTO VERTICALELLIPTICALPIPE
      HORIZONTALELLIPTICALPIPE:
        V1#(I5%)=(HORVVF#(J%-1)+PERCENTFLOW#*(HORVVF#(J%)-HORVVF#(J%-1)))*V#(I5%)
        REM PRINT V1#(I5%),J%,HORVVF#(J%),PERCENTFLOW#,PARTFLOW1#,QQF#(J%):STOP
        GOTO PRINTFLOW
      VERTICALELLIPTICALPIPE:
        V1#(I5%)=(VERTVVF#(J%-1)+PERCENTFLOW#*(VERTVVF#(J%)-VERTVVF#(J%-1)))*V#(I5%)
        GOTO PRINTFLOW
  PRINTFLOW:
    IF Q1#(I5%)>999.99 THEN
      INVALIDSIZE=1
      RETURN
    END IF
    LOCATE 18,27:PRINT USING "###.##"; Q1#(I5%)
    LOCATE 18,35:PRINT USING "##.##"; V#(I5%)
    LOCATE 18,42:PRINT USING "##.##"; V1#(I5%)
RETURN

ENTERPIPELENGTH:
  IF L#(I5%)=0 THEN L#(I5%)=25
  L$=MID$(STR$(L#(I5%)),2,5)
  ENTERLENGTH1:
    LOCATE 18,50:CALL PROM(L$,5,1)
    L#(I5%)=VAL(L$)
  IF L#(I5%)=0 THEN GOTO ENTERLENGTH1
  F#(I5%)=SL#(I5%)*L#(I5%)
  LOCATE 18,55:PRINT USING "##.##"; F#(I5%)
  T2#(I5%)=L#(I5%)/(V1#(I5%)*60)
  LOCATE 13,53:PRINT USING "###.##"; T2#(I5%)
RETURN

ENTERUPPERINVERT:
  D#=0:D3#=100000:L1#=0
  FOR K2%=1 TO I5%
    IF IN2$(K2%)=IN1$(I5%) THEN
      D1#=D#(K2%)
      A$=MID$(D$(K2%),3,1)
      A1$=MID$(D$(K2%),4,1)
      IF A$="H" OR A1$="H" THEN
        FOR J%=1 TO 23
          IF D#(K2%)=MAJORSIZE#(J%) THEN D1#=MINORSIZE#(J%)
        NEXT J%
      END IF
      IF D1#/12+L1#(K2%)<D3# THEN
        D#=D1#
        K3%=K2%:D3#=D1#/12+L1#(K2%)
      END IF
    END IF
  NEXT K2%
  DI#=D#(I5%)
  A$=MID$(D$(I5%),3,1)
  A1$=MID$(D$(I5%),4,1)
  IF A$="H" OR A1$="H" THEN
    FOR J%=1 TO 23
      IF D#(I5%)=MAJORSIZE#(J%) THEN D1#=MINORSIZE#(J%)
    NEXT J%
  END IF
  U1#(I5%)=L1#(K3%)+(D#-D1#)/12
  FOR K2%=1 TO I5%
    IF IN2$(K2%)=IN1$(I5%) THEN
      IF L1#(K2%)<U1#(I5%) THEN U1#(I5%)=L1#(K2%)
    END IF
  NEXT K2%
  IF D#=0 THEN U1#(I5%)=0
  U1$=MID$(STR$((INT(U1#(I5%)*100+.5))/100),2,6)
  IF D#=0 THEN U1$=" "
  LOCATE 18,63:CALL PROM(U1$,6,1)
  IF ABS(VAL(U1$)-U1#(I5%))>.005 THEN
    U1#(I5%)=VAL(U1$)
  END IF
  L1#(I5%)=U1#(I5%)-F#(I5%)
  LOCATE 18,69:PRINT USING "###.##"; L1#(I5%)
RETURN


CLEARLOWERPIPE:
  LOCATE 13,1:PRINT "                                                                               "
  LOCATE 18,1:PRINT "                                                                               "
RETURN

CLEARMENU:
  LOCATE 20,4:PRINT"                                                                       "	
  LOCATE 21,4:PRINT"                                                                         "	
  LOCATE 22,4:PRINT"                                                                "
  LOCATE 23,28:PRINT"                        "
RETURN

CHANGEA5:
  GOSUB ENTERA5
  GOSUB CALCREQFLOW
RETURN

CHANGEIN1:
  GOSUB ENTERIN1
  GOSUB CALCREQFLOW
RETURN

CHANGEIN2:
  GOSUB ENTERIN2
  GOSUB CALCREQFLOW
RETURN

CHANGED:
  GOSUB ENTERPIPESIZE
  GOSUB CALCULATEPIPEFLOW
  GOSUB CALCULATEFT2L1
RETURN

CHANGESL:
  GOSUB ENTERSLOPE
  GOSUB CALCULATEPIPEFLOW
  GOSUB CALCULATEFT2L1
RETURN

CHANGEN:
  GOSUB ENTERMANNINGSN
  GOSUB CALCULATEPIPEFLOW
  GOSUB CALCULATEFT2L1
RETURN

CHANGEL:
  GOSUB ENTERPIPELENGTH
  GOSUB CALCULATEFT2L1
RETURN

CHANGEU1:
  GOSUB ENTERUPPERINVERT
RETURN

CHANGEL1:
  L1$=MID$(STR$(L1#(I5%)+.001),2,6)
  LOCATE 18,63:CALL PROM(L1$,6,1)
  IF ABS(VAL(L1$)-L1#(I5%))>.002 THEN
    L1#(I5%)=VAL(L1$)
  END IF
  SL#(I5%)=(U1#(I5%)-L1#(I5%))/L#(I5%)
  GOSUB CALCULATEPIPEFLOW
  LOCATE 18,13:PRINT USING "#.###"; SL#(I5%)*100
  GOSUB CALCULATEFT2L1
RETURN

CALCULATEFT2L1:
  F#(I5%)=SL#(I5%)*L#(I5%)
  LOCATE 18,55:PRINT USING "##.##"; F#(I5%)
  T2#(I5%)=L#(I5%)/(V1#(I5%)*60)
  LOCATE 13,53:PRINT USING "###.##"; T2#(I5%)
  L1#(I5%)=U1#(I5%)-F#(I5%)
  LOCATE 18,69:PRINT USING "###.##"; L1#(I5%)
RETURN



REM PRINT PIPE DATA ROUTINE
'----------------------------------------------------------------------------'

PRINTPIPEDATA:
  ON ERROR GOTO 0
  CLS
  GOSUB FILETEST
  IF NUM1%=0 THEN
    LOCATE 10,25:COLOR 15,0:PRINT "NO PIPES HAVE BEEN ENTERED!"
    DELAY 3:COLOR 7,0
    GOTO START
  END IF
  GOSUB GETDATE
  GOSUB HEADING
  GOSUB PRINTPIPEMENU
  START5:
    LOCATE 15,29:Y1$="1":CALL PROM(Y1$,1,1)
    IF Y1$="1" THEN GOSUB PRINTPIPEDATA1
    IF Y1$="2" THEN GOSUB PRINTOP
    IF Y1$="3" THEN RETURN
    GOTO START5

PRINTPIPEMENU:
  LOCATE 8,18:PRINT FNBOX$(39,9)
  LOCATE 9,21:PRINT"ENTER NUMBER OF DESIRED FUNCTION:"
  LOCATE 11,23:PRINT"1) PRINT PIPE DATA"
  LOCATE 12,23:PRINT"2) INCLUDE OUTLET PROTECTION"
  LOCATE 13,23:PRINT"3) EXIT TO MAIN MENU"
  LOCATE 15,21:PRINT"NUMBER? "
RETURN

PRINTOP:
  J%=0:PRINTOUTLETPROTECTION%=1
  FOR K2%=1 TO NUM1%
    IF MID$(IN2$(K2%),1,2)="HW" THEN
      CLS:GOSUB HEADING
      LOCATE 9,21:PRINT"ENTER TYPE OF OUTLET PROTECTION FOR ";IN2$(K2%)
      LOCATE 11,23:PRINT"1) RIP-RAP APRON"
      LOCATE 12,23:PRINT"2) PREFORMED SCOUR HOLE"
      LOCATE 14,21:PRINT"NUMBER? "
      ENTER3:
        K$="1"
        LOCATE 14,29:CALL PROM(K$,1,1)
        IF K$<>"1" AND K$<>"2" THEN GOTO ENTER3
      INCR J%
      LOCATE 18,21:PRINT"ENTER THE TAILWATER DEPTH: ";
      D4$=MID$(STR$(.2*(VAL(MID$(D$(K2%),1,2)))/12),2,5)
      CALL PROM(D4$,5,1)
      W1#(J%)=VAL(D4$)
      D1%(J%)=0
      IF K$="2" THEN
        LOCATE 20,5:PRINT"ENTER DEPTH OF SCOUR HOLE (1 -- DEPTH = DIA,   2 -- DEPTH = DIA/2): ";
        ENTER4:
          D7$="1":CALL PROM(D7$,1,1):D1%(J%)=VAL(D7$)
          IF D7$<>"1" AND D7$<>"2" THEN GOTO ENTER4
      END IF
    END IF
    CLS
  NEXT K2%
  GOSUB HEADING
  GOSUB PRINTPIPEMENU
RETURN

PRINTPIPEDATA1:
  B1$="###.##":B2$="#.##":B3$="##.##":B4$="#.#####":B5$="#.###":B6$="####"
  J%=0
  PRINTPIPELABEL1:
  FILEADDRESS$="LPT1"
  LOCATE 22,11:PRINT"SELECT OUTPUT FILE ADDRESS (LPT1=PRINTER): ";
  CALL PROM(FILEADDRESS$,12,1)
  IF FILEADDRESS$ = "LPT1        " THEN FILEADDRESS$ = "LPT1:"
  IF FILEADDRESS$ = "SCRN        "_
    OR FILEADDRESS$ = "SCRN:       "_
    OR FILEADDRESS$ = "CON         " THEN GOTO PRINTPIPELABEL1
    OPEN FILEADDRESS$ FOR OUTPUT AS #3
    IF FILEADDRESS$="LPT1:" THEN
      WIDTH #3, 133
      PRINT #3, CHR$(15)
      ON ERROR GOTO 0   'PUT IN ERROR CONTROL FOR PAPER ERROR, DESELECTED, ETC.
    END IF
    GOSUB PRINTPIPEHEADING
    FOR I%=1 TO NUM1%
      GOSUB PIPESIZEDES
      IF A6#(I%)=A7#(I%) THEN GOSUB CALCPAGELENGTH
      GOSUB PRINTPIPES
      IF PRINTOUTLETPROTECTION%=1 THEN GOSUB PRINTOP1
    NEXT I%
    IF FILEADDRESS$="LPT1:" THEN
      PRINT #3, CHR$(18)
      PRINT #3, CHR$(12)
    END IF
  CLOSE #3
  LOCATE 22,11:PRINT"                                                        "
  PRINTOUTLETPROTECTION%=0
RETURN

PRINTPIPEHEADING:
  PRINT #3, "                                                  * * * STORM SEWER DESIGN * * *"
  PRINT #3, "":PRINT #3, ""
  PRINT #3, "PROJECT: "; P1$; " TIME CONC. METHOD: SCS VELOCITY CHART              CALC. BY: "; P5$
  IF N$="1" THEN G$=Z4$
  IF N$="2" THEN G$=Z5$
  PRINT #3, "INTENSITY DATA: "; G$; "   RATIONAL METHOD - "; I1$; " YEAR STORM"; "           "; DATE1$
  PRINT #3, "------------------------------------------------------------------------------------------------------------------------------------"
  PRINT #3, "  LOCATION          AREA            TIME OF FLOW (MIN.)       Q=CiA               DESIGN                            PROFILE"
  PRINT #3, "DES. FR.  TO     INC.   TOT.    C     TO    IN    TIME    I      Q    PIPE     S     N     CAP.  VEL.  VEL. LEN.  FALL  UPPER  LOWER"
  PRINT #3, "                  A      A          INLET  CHAN.  CONC.         CFS.  SIZE    (%)          CFS.  FULL  ACT.  FT.   FT.   INV.   INV."
  PRINT #3, "------------------------------------------------------------------------------------------------------------------------------------"
RETURN

PIPESIZEDES:
  IF MID$(D$(I%),3,1)<>"H" AND MID$(D$(I%),3,1)<>"V" AND MID$(D$(I%),4,1)<>"H"_
     AND MID$(D$(I%),4,1)<>"V" THEN
      D2$="   "+D$(I%)+" "
      D3#=VAL(D$(I%))
      RETURN
  END IF
  IF MID$(D$(I%),3,1)="H" OR MID$(D$(I%),3,1)="V" THEN
    D3#=VAL(MID$(D$(I%),1,2))
    D4$=MID$(D$(I%),3,1)
  END IF
  IF MID$(D$(I%),4,1)="H" OR MID$(D$(I%),4,1)="V" THEN
    D3#=VAL(MID$(D$(I%),1,3))
    D4$=MID$(D$(I%),4,1)
  END IF
  FOR K%=1 TO 23
    IF (ABS(MAJORSIZE#(K%)-D3#))<1 THEN
      D3$=STR$(D3#)
      IF MAJORSIZE#(K%)>99 THEN
        D3$=MID$(STR$(D3#),2,4)
      END IF
      D5$=MID$(STR$(MINORSIZE#(K%)),2,3)
      IF MINORSIZE#(K%)>99 THEN
        D5$=MID$(STR$(MINORSIZE#(K%)),2,4)
      END IF
      IF MINORSIZE#(K%)<100 THEN
        D4$=D4$+" "
      END IF
      D2$=D3$+"X"+D5$+D4$
    END IF
  NEXT K%
RETURN

PRINTPIPES:
  PRINT #3, A5$(I%); " "; IN1$(I%); IN2$(I%);:PRINT #3, USING B1$; A6#(I%);
  PRINT #3, " ";:PRINT #3, USING B1$; A7#(I%);:PRINT #3, "  ";
  PRINT #3, USING B2$; COMP1#(I%);:PRINT #3, " ";:PRINT #3, USING B1$; T1#(I%);
  PRINT #3, " ";:PRINT #3, USING B3$; T2#(I%);:PRINT #3, " ";
  PRINT #3, USING B1$; T3#(I%);:PRINT #3, "  ";:PRINT #3, USING B2$; INT1#(I%);
  PRINT #3, " ";:PRINT #3, USING B1$; Q#(I%);:PRINT #3, " "; D2$; " ";
  PRINT #3, USING B5$; SL#(I%)*100;:PRINT #3, " ";:PRINT #3, USING B5$; N#(I%);
  PRINT #3, " ";:PRINT #3, USING B1$; Q1#(I%);:PRINT #3, " ";
  PRINT #3, USING B3$; V#(I%);:PRINT #3, " ";:PRINT #3, USING B3$; V1#(I%);
  PRINT #3, " ";:PRINT #3, USING B6$; L#(I%);:PRINT #3, " ";
  PRINT #3, USING B3$; F#(I%);:PRINT #3, " ";:PRINT #3, USING B1$; U1#(I%);
  PRINT #3, " ";:PRINT #3, USING B1$; L1#(I%)
RETURN

CALCPAGELENGTH:
  PRINT #3, ""
  IF I%=300 THEN RETURN
  FOR J1%= I%+1 TO NUM1%
    IF A6#(J1%)=A7#(J1%) OR J1%=NUM1% THEN
      U%=U%+(J1%-I%)+1
      IF PRINTOUTLETPROTECTION%=1 AND MID$(IN2$(J1%-1),1,2)="HW" THEN U%=U%+3
      IF U%>45 THEN
        U%=0
        GOSUB PRINTPIPEHEADING
        IF FILEADDRESS$="LPT1:" THEN
          PRINT #3, CHR$(12)
        END IF
        RETURN
      END IF
      RETURN
    END IF
  NEXT J1%
RETURN

PRINTOP1:
  IF MID$(IN2$(I%),1,2) = "HW" THEN
    D3#=D3#/12
    J%=J%+1
    IF D1%(J%)=0 THEN GOSUB RIPRAPAPRON
    IF D1%(J%)>0 THEN GOSUB SCOURHOLE
  END IF
RETURN

RIPRAPAPRON:
  D9#=((.02/W1#(J%))*((Q#(I%)/D3#)^(4/3)))*12
  W3#=3*D3#
  IF W1#(J%)>=.5*D3# THEN
    L2#=3*Q#(I%)/(D3#)^1.5
    W2#=3*D3#+.4*L2#
  END IF
  IF W1#(J%)<.5*D3# THEN
    L2#=1.8*Q#(I%)/(D3#)^1.5+7*D3#
    W2#=3*D3#+L2#
  END IF
  PRINT #3, ""
  PRINT #3, "RIP-RAP APRON DIMENSIONS:    APRON LENGTH = ";:
  PRINT #3, USING B1$; L2#;:PRINT #3, " FT.   CULVERT END APRON WIDTH = ";
  PRINT #3, USING B1$; W3#;:PRINT #3, " FT.   DOWNSTREAM APRON WIDTH = ";
  PRINT #3, USING B1$; W2#;:PRINT #3, " FT."
  PRINT #3, "                             TAILWATER DEPTH = ";:
  PRINT #3, USING B2$; W1#(J%);:PRINT #3, " FT.   MEDIAN STONE SIZE DIAMETER = ";
  PRINT #3, INT(D9#+1);:PRINT #3, " INCHES";
RETURN

SCOURHOLE:
  L2#=3*D3#
  W2#=2*D3#
  IF D1%(J%)=1 THEN
    L3#=9*D3#
    W3#=8*D3#
    D9#=((0.0082/W1#(J%))*((Q#(I%)/D3#)^(4/3)))*12
    D1#=D3#
  END IF
  IF D1%(J%)=2 THEN
    L3#=6*D3#
    W3#=5*D3#
    D9#=((0.0125/W1#(J%))*((Q#(I%)/D3#)^(4/3)))*12
    D1#=D3#*.5
  END IF
  PRINT #3, ""
  PRINT #3, "PREFORMED SCOUR HOLE DIMENSIONS:  BOTTOM WIDTH =";:
  PRINT #3, USING B1$; W2#;:PRINT #3, " FT.  TOP WIDTH =";
  PRINT #3, USING B1$; W3#;:PRINT #3, " FT.  BOTTOM LENGTH =";
  PRINT #3, USING B1$; L2#;:PRINT #3, " FT.  TOP LENGTH =";
  PRINT #3, USING B1$; L3#;:PRINT #3, " FT."
  PRINT #3, "                                  TAILWATER DEPTH =";:
  PRINT #3, USING B2$; W1#(J%);:PRINT #3, " FT.  MEDIAN STONE SIZE DIAMETER = ";
  PRINT #3, INT(D9#+1);:PRINT #3, " INCHES     DEPTH OF HOLE = ";
  PRINT #3, USING B2$; D1#;:PRINT #3, " FT."
RETURN
